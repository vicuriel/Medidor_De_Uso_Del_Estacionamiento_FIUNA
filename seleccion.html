<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Seleccionar lugar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { box-sizing:border-box; margin:0; padding:0; font-family:system-ui,sans-serif; }
    body {
      min-height:100vh;
      background:#ffffff;
      color:#111827;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:24px;
    }
    header {
      width:100%; max-width:900px; margin-bottom:20px;
      border-bottom:1px solid #e5e7eb; padding-bottom:10px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .title-block { border-left:4px solid #b00020; padding-left:10px; }
    header h1 { font-size:1.4rem; margin-bottom:2px; }
    
    .logout {
      font-size:0.8rem; cursor:pointer; color:#b00020;
      border:1px solid #b00020; border-radius:999px;
      padding:6px 10px; background:#ffffff;
    }
    .logout:hover { background:#b00020; color:#ffffff; }

    main { width:100%; max-width:900px; margin-top:10px; }

    .grid {
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:20px;
    }

    .card {
      border-radius:16px;
      border:1px solid #e5e7eb;
      padding:12px;
      cursor:pointer;
      transition:150ms;
      min-height:240px;
      display:flex;
      flex-direction:column;
    }

    .card:hover {
      border-color:#b00020;
      transform:translateY(-2px);
      box-shadow:0 4px 10px rgba(0,0,0,0.08);
    }

    .card img {
      width:100%;
      height:160px;
      object-fit:cover;
      border-radius:12px;
      border:1px solid #b00020;
      background:#fee2e2;
    }

    .card-title {
      margin-top:8px;
      text-align:center;
      font-size:1rem;
      font-weight:600;
    }

    .percent-area {
      margin-top:4px;
      font-size:0.8rem;
      color:#4b5563;
    }

    .percent-bar {
      margin-top:4px; width:100%; height:6px;
      border-radius:999px;
      background:#f3f4f6; overflow:hidden;
    }

    .percent-fill {
      height:100%; width:0%; background:#b00020;
      transition:width 0.2s linear;
    }

    .percent-text {
      margin-top:2px;
      text-align:right;
      font-size:0.75rem;
      color:#6b7280;
    }

    .status-mini {
      margin-top:10px;
      font-size:0.75rem;
      color:#9ca3af;
    }
  </style>
</head>
<body>

<header>
  <div class="title-block">
    <h1>Lugares</h1>
  </div>

  <button class="logout" onclick="salir()">Cerrar sesión</button>
</header>

<main>
  <div class="grid">

    <div class="card" onclick="abrirLugar(1)">
      <img src="imagenes/principal.png" alt="Principal">
      <div class="card-title">Principal</div>
      <div class="percent-area" onclick="event.stopPropagation()">
        Ocupación actual
        <div class="percent-bar">
          <div class="percent-fill" id="fill-1"></div>
        </div>
        <div class="percent-text" id="text-1">0% ocupado</div>
      </div>
    </div>

    <div class="card" onclick="abrirLugar(2)">
      <img src="imagenes/bozzano.png" alt="Bozzano">
      <div class="card-title">Bozzano</div>
      <div class="percent-area" onclick="event.stopPropagation()">
        Ocupación actual
        <div class="percent-bar">
          <div class="percent-fill" id="fill-2"></div>
        </div>
        <div class="percent-text" id="text-2">0% ocupado</div>
      </div>
    </div>

    <div class="card" onclick="abrirLugar(3)">
      <img src="imagenes/yuyal.png" alt="Yuyal">
      <div class="card-title">Yuyal</div>
      <div class="percent-area" onclick="event.stopPropagation()">
        Ocupación actual
        <div class="percent-bar">
          <div class="percent-fill" id="fill-3"></div>
        </div>
        <div class="percent-text" id="text-3">0% ocupado</div>
      </div>
    </div>

    <div class="card" onclick="abrirLugar(4)">
      <img src="imagenes/lar.png" alt="LAR">
      <div class="card-title">LAR</div>
      <div class="percent-area" onclick="event.stopPropagation()">
        Ocupación actual
        <div class="percent-bar">
          <div class="percent-fill" id="fill-4"></div>
        </div>
        <div class="percent-text" id="text-4">0% ocupado</div>
      </div>
    </div>

  </div>

  <div class="status-mini" id="statusMini">
    Conectando al ESP32...
  </div>
</main>

<script>
  const ESP32_HOST = "172.16.254.227";
  const API_BASE   = "http://" + ESP32_HOST;

  const CAPACIDAD_MAX = { 1:50, 2:50, 3:50, 4:50 };
  const contadores = { 1:0, 2:0, 3:0, 4:0 };

  function abrirLugar(n) {
    window.location.href = "principal.html?slot=" + n;
  }

  function salir() {
    localStorage.removeItem("usuarioActual");
    window.location.href = "login.html";
  }

  function actualizarLugar(id) {
    const capacidad = CAPACIDAD_MAX[id] || 1;
    let porcentaje = Math.round((contadores[id] * 100) / capacidad);

    if (porcentaje < 0) porcentaje = 0;
    if (porcentaje > 100) porcentaje = 100;

    document.getElementById("fill-" + id).style.width = porcentaje + "%";
    document.getElementById("text-" + id).textContent =
      contadores[id] === 0 ? "0% ocupado" : porcentaje + "% ocupado";
  }

  async function cargarEstado() {
    const statusMini = document.getElementById("statusMini");
    try {
      const res = await fetch(API_BASE + "/state");
      if (!res.ok) throw new Error("HTTP " + res.status);

      const data = await res.json();

      [1,2,3,4].forEach(id => {
        if (typeof data[String(id)] === "number") {
          contadores[id] = data[String(id)];
          actualizarLugar(id);
        }
      });

      statusMini.textContent = "Conectado a " + ESP32_HOST;

    } catch (err) {
      statusMini.textContent = "Error /state (" + err.message + ")";
    }
  }

  setInterval(cargarEstado, 1000);
  cargarEstado();
</script>

</body>
</html>
